name: SonarCloud Analysis

on:
  push:
    branches:
      - chite  # Asegúrate de que coincide con tu rama

jobs:
  sonarcloud-analysis:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/Doc2Markdown

    steps:
      # Paso 1: Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para SonarCloud

      # Paso 2: Configurar entorno ODBC
      - name: Set up ODBC Driver 17
        run: |
          sudo apt-get update
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/
          sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/microsoft.list'
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 mssql-tools unixodbc-dev
          echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> $GITHUB_ENV

      # Paso 3: Instalar Java (requerido por SonarScanner)
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Paso 4: Instalar SonarScanner
      - name: Install SonarScanner
        run: |
          SONAR_SCANNER_VERSION="5.0.1.3006"
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip
          unzip sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip
          sudo mv sonar-scanner-${SONAR_SCANNER_VERSION}-linux /opt/sonar-scanner
          echo "$(/opt/sonar-scanner/bin/sonar-scanner --version)"

      # Paso 5: Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'  # Ajusta a tu versión

      # Paso 6: Instalar dependencias
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r Doc2Markdown/requirements.txt
          pip install pytest pytest-cov sqlalchemy pyodbc

      # Paso 7: Ejecutar pruebas y generar cobertura
      - name: Run tests with coverage
        run: |
          cd Doc2Markdown
          pytest tests/unit_tests \
            --cov=app \
            --cov-report=xml:report_coverage/coverage.xml \
            --cov-report=term

      # Paso 8: Ejecutar análisis SonarCloud
      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          /opt/sonar-scanner/bin/sonar-scanner \
            -Dsonar.projectKey=jaimeflores_doc2markdown \
            -Dsonar.organization=jaimeflores \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.python.coverage.reportPaths=report_coverage/coverage.xml \
            -Dsonar.language=py \
            -Dsonar.python.version=3.10 \
            -Dsonar.working.directory=${{ github.workspace }}/.scannerwork \
            -Dsonar.scm.disabled=true